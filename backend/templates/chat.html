{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- Collapsible Left Sidebar -->
    <div class="sidebar-container" id="sidebar-container" style="width: 280px; transition: all 0.3s ease; overflow-x: visible;">
    <!-- Sidebar Header with Toggle -->
    <div class="d-flex justify-content-between align-items-center mb-3" style="margin-top: 110px; padding: 0 15px;">
        <h6 class="text-muted mb-0" id="sidebar-title" style="font-weight: 600; font-size: 0.9rem;">Menu</h6>
        <button class="btn btn-sm p-1" id="sidebar-toggle" style="border: none; background: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
        </button>
    </div>
    
    <!-- Sidebar Content -->
    <div class="sidebar-content" id="sidebar-content" style="padding: 0 15px; overflow-x: visible;">
        <!-- New Chat and Search Section -->
        <div class="d-flex flex-column gap-2 mb-4">
            <button type="button" class="btn btn-light border-0 text-start d-flex align-items-center py-2 px-3" id="new-chat-btn" style="background-color: #f8f9fa; border-radius: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square me-2" viewBox="0 0 16 16">
                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                <span class="sidebar-text">New chat</span>
            </button>
        </div>
        
        <!-- Divider -->
        <hr class="my-3" style="border-color: #e5e7eb;">
        
        <!-- Chats Section -->
        <div class="mb-3" style="flex: 1; display: flex; flex-direction: column;">
            <h6 class="text-muted small px-3 mb-2 sidebar-text" style="font-weight: 600; font-size: 0.75rem;">Chats</h6>
            
            <!-- Scrollable Chat Sessions Container -->
            <div id="session-history-container" style="flex: 1; overflow-y: auto; overflow-x: visible;">
                <div id="session-list" class="d-flex flex-column gap-1">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
    
    <!-- Main Content Area -->
    <div class="col" id="main-content">
        <!-- Your existing main content here -->
        <!-- Centered large logo above chat input bar -->
        <div class="sticky-top sticky-chatbar bg-white pt-2 pb-2" style="z-index:1021;">
            <div class="w-100 d-flex justify-content-center mb-3">
                <img src="/static/jericho_image.jpg" alt="Chat Logo" style="height:80px; max-width:320px; width:auto; display:block;">
            </div>
            
            <div class="d-flex align-items-center mb-2">
                <form id="chat-form" class="d-flex align-items-center flex-grow-1" onsubmit="return false;">
                    <div class="flex-grow-1 me-2">
                        <textarea class="form-control" name="query" id="query-textarea" rows="1" placeholder="Ask a question..." required style="resize:none; min-height:40px; max-height:120px; overflow-y:auto;"></textarea>
                    </div>
                    <button type="button" class="btn btn-success ms-2" id="enter-btn" title="Send">Enter</button>
                    <label for="file-upload" class="input-group-text bg-white border-end-0 ms-2" style="cursor:pointer;" title="Upload PDF(s) or ZIP">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#0d6efd" class="bi bi-upload" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v3.1a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V10.4a.5.5 0 0 1 1 0v3.1A2 2 0 0 1 14 15.5H2A2 2 0 0 1 0 13.5V10.4a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V10.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 1-.708-.708l3-3z"/>
                        </svg>
                    </label>
                    <input id="file-upload" type="file" name="files" accept=".pdf,.zip,.docx" multiple style="display:none;">
                    <div class="input-group-text bg-white border-start-0 ms-2">
                        <input class="form-check-input mt-0" type="checkbox" name="private" id="private" title="Private Upload">
                        <label class="form-check-label ms-1" for="private" style="font-size:0.95em;">Private</label>
                    </div>
                    <button type="button" class="btn btn-primary ms-2" id="upload-btn" title="Upload PDF">Upload</button>
                </form>
            </div>
            <div id="status-area" class="mt-2"></div>
            <div id="upload-status" class="mt-2"></div>
        </div>
        <div id="chat-answer" class="mt-3"></div>
        <div id="chat-history"></div>
    </div>
</div>
    
    
</div>

<!-- Session Rename Modal -->
<div class="modal fade" id="renameSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Chat Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="newSessionName" placeholder="Enter new session name">
                <input type="hidden" id="sessionToRename">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRename">Rename</button>
            </div>
        </div>
    </div>
</div>

<style>

/* Sidebar Container */
.sidebar-container {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    background-color: #f8f9fa;
    border-right: 1px solid #e5e7eb;
    z-index: 2000;
    overflow: visible !important; /* Important: allow overflow */
}

.sidebar-content {
    height: calc(100vh - 110px);
    overflow: visible !important;
    padding-bottom: 20px;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 2001;
}

.sidebar-container.collapsed {
    width: 60px !important;
}

.sidebar-container.collapsed .sidebar-text {
    display: none;
}

.sidebar-container.collapsed #sidebar-title {
    display: none;
}

.sidebar-container.collapsed #sidebar-toggle svg {
    transform: rotate(180deg);
}

/* Main content adjustment */
#main-content {
    margin-left: 280px;
    transition: margin-left 0.3s ease;
}

#main-content.expanded {
    margin-left: 60px;
}

/* Header should always stay fixed at top */
.navbar, .navbar-expand, .navbar-dark, .bg-dark, .fixed-top {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    z-index: 3000 !important;
    margin-left: 0 !important;
}

/* Ensure header content doesn't get affected by sidebar */
.navbar .container, .navbar .container-fluid {
    margin-left: 0 !important;
    padding-left: 15px !important;
}

/* Custom scrollbar styles */
#session-history-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: visible;
    scrollbar-width: none;
    -ms-overflow-style: none;
    position: relative;
    z-index: 2002;
}

#session-history-container::-webkit-scrollbar {
    display: none;
}

#session-history-container::-webkit-scrollbar-track {
    background: transparent;
}

#session-history-container::-webkit-scrollbar-thumb {
    background-color: #cbd5e0;
    border-radius: 3px;
}

#session-history-container::-webkit-scrollbar-thumb:hover {
    background-color: #a0aec0;
}

/* Session list dropdown styles */

.session-item .dropdown-menu .dropdown-item {
    padding: 8px 12px !important;
    border-radius: 0 !important;
    transition: all 0.2s ease !important;
    font-weight: 500 !important;
    color: #374151 !important;
    display: flex !important;
    align-items: center !important;
    white-space: nowrap !important;
}

.session-item .dropdown-menu .dropdown-item:hover {
    background-color: #f3f4f6 !important;
    color: #111827 !important;
}

.session-item .dropdown-menu .dropdown-item.text-danger {
    color: #dc2626 !important;
}

.session-item .dropdown-menu .dropdown-item.text-danger:hover {
    background-color: #fef2f2 !important;
    color: #dc2626 !important;
}

.session-item .dropdown-menu .dropdown-divider {
    margin: 4px 0 !important;
    border-color: #e5e7eb !important;
}

.session-item .dropdown-menu {
    position: absolute !important;
    z-index: 20050 !important;
    min-width: 150px !important;
    margin-top: 5px !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    border: 1px solid #dee2e6 !important;
    background-color: #ffffff !important;
    font-size: 0.9em !important;
    border-radius: 8px !important;
    padding: 8px 0 !important;
    white-space: nowrap !important;
}

.session-item .dropdown-menu.show {
    display: block !important;
}

.session-item .dropdown {
    position: relative !important;
    z-index: 9998;
}

.session-item {
    position: relative;
    z-index: 2003;
}

.session-item:hover .btn {
    opacity: 1 !important;
}

/* Ensure sidebar allows overflow for dropdown */
.sidebar-container {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    background-color: #f8f9fa;
    border-right: 1px solid #e5e7eb;
    z-index: 2000;
    overflow: visible !important;
}

.sidebar-content {
    height: calc(100vh - 110px);
    overflow: visible !important;
    padding-bottom: 20px;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 2001;
}

#session-history-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: visible;
    scrollbar-width: none;
    -ms-overflow-style: none;
    position: relative;
    z-index: 2002;
}

</style>

<script>
const statusArea = document.getElementById('status-area');
const uploadStatus = document.getElementById('upload-status');
const enterBtn = document.getElementById('enter-btn');
const uploadBtn = document.getElementById('upload-btn');
const fileInput = document.getElementById('file-upload');
const queryTextarea = document.getElementById('query-textarea');

// Current session management
let currentSessionId = null;
let userSessions = [];

// Load session when clicked
function loadSession(sessionId, sessionName) {
    currentSessionId = sessionId;
    
    // Update UI to show selected session
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-session-id="${sessionId}"]`).classList.add('active');
    
    // Load session history
    fetch(`/history?session_id=${sessionId}`)
        .then(response => response.json())
        .then(data => {
            chatHistory = data.history || [];
            displayChatHistory();
        })
        .catch(error => {
            console.error('Error loading session:', error);
        });
}

// Display chat history in the main area
function displayChatHistory() {
    const chatContainer = document.getElementById('chat-messages');
    chatContainer.innerHTML = '';
    
    if (chatHistory.length === 0) {
        chatContainer.innerHTML = '<div class="text-muted text-center">No chat history yet.</div>';
        return;
    }
    
    chatHistory.forEach(item => {
        // User message
        const userDiv = document.createElement('div');
        userDiv.className = 'mb-3';
        userDiv.innerHTML = `
            <div class="d-flex justify-content-end">
                <div class="bg-primary text-white p-3 rounded-3 max-width-70">
                    ${item.question}
                </div>
            </div>
        `;
        chatContainer.appendChild(userDiv);
        
        // Assistant response
        const assistantDiv = document.createElement('div');
        assistantDiv.className = 'mb-3';
        assistantDiv.innerHTML = `
            <div class="d-flex justify-content-start">
                <div class="bg-light p-3 rounded-3 max-width-70">
                    ${item.answer}
                </div>
            </div>
        `;
        chatContainer.appendChild(assistantDiv);
    });
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Update session list after rename
function updateSessionInSidebar(sessionId, newName) {
    const sessionElement = document.querySelector(`[data-session-id="${sessionId}"] .session-name`);
    if (sessionElement) {
        sessionElement.textContent = newName;
    }
}

// Modify your existing query submission to update the sidebar
function submitQuery() {
    // ... your existing query submission code ...
    
    // After successful query, if session name was updated, refresh the sidebar
    if (response.session_name_updated) {
        loadUserSessions(); // Refresh the session list
    }
}

// Load user sessions for sidebar
function loadUserSessions() {
    fetch('/user_sessions')
        .then(response => response.json())
        .then(data => {
            updateSessionsSidebar(data.sessions);
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
        });
}

function updateSessionsSidebar(sessions) {
    const sessionsList = document.getElementById('sessions-list');
    sessionsList.innerHTML = '';
    
    sessions.forEach(session => {
        const sessionDiv = document.createElement('div');
        sessionDiv.className = 'session-item p-2 mb-1 rounded cursor-pointer';
        sessionDiv.setAttribute('data-session-id', session.session_id);
        sessionDiv.onclick = () => loadSession(session.session_id, session.session_name);
        
        sessionDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-chat-left me-2"></i>
                <span class="session-name flex-grow-1">${session.session_name}</span>
                <div class="dropdown">
                    <button class="btn btn-sm" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="renameSession(${session.session_id})">Rename</a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteSession(${session.session_id})">Delete</a></li>
                    </ul>
                </div>
            </div>
        `;
        
        sessionsList.appendChild(sessionDiv);
    });
}

// Load sessions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUserSessions();
});


// Spinner HTML
function showSpinner(msg="Please wait while I am generating answer for you...") {
    statusArea.innerHTML = `<div class="d-flex align-items-center text-secondary">
        <span class="spinner-border spinner-border-sm me-2"></span> ${msg}
    </div>`;
}

// Hide spinner/status
function hideSpinner() {
    statusArea.innerHTML = "";
}

// Replace your toggleDropdown function with this:
function toggleDropdown(event, sessionId) {
    event.stopPropagation();

    // Close all open dropdowns
    document.querySelectorAll('.dropdown-menu.show').forEach(menu => menu.classList.remove('show'));

    const button = event.target.closest('button');
    const dropdown = event.target.closest('.dropdown').querySelector('.dropdown-menu');
    const rect = button.getBoundingClientRect();
    const sidebarRect = document.getElementById('sidebar-container').getBoundingClientRect();

    // Position dropdown relative to sidebar, not viewport
    dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
    dropdown.style.left = (rect.left - sidebarRect.left + rect.width + 5) + 'px';
    dropdown.style.right = 'auto'; // Clear any right positioning
    dropdown.classList.add('show');
}


// Handle file selection display
fileInput.onchange = function() {
    const files = Array.from(this.files);
    const selectedFilesDiv = document.getElementById('selected-files');
    const fileListDiv = document.getElementById('file-list');
    
    if (files.length > 0) {
        selectedFilesDiv.style.display = 'block';
        fileListDiv.innerHTML = files.map(file => {
            const fileType = file.name.toLowerCase().endsWith('.zip') ? 'ZIP' : 'PDF';
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            return `
                <div class="d-flex justify-content-between align-items-center py-1">
                    <div>
                        <span class="badge bg-${fileType === 'ZIP' ? 'warning' : 'primary'} me-2">${fileType}</span>
                        <small>${file.name}</small>
                    </div>
                    <small class="text-muted">${fileSize} MB</small>
                </div>
            `;
        }).join('');
    } else {
        selectedFilesDiv.style.display = 'none';
    }
};

// Add event listener to handle dropdown show events
document.addEventListener('show.bs.dropdown', function (e) {
    closeAllDropdowns();
});

// Handle chat submit (question only)
enterBtn.onclick = async function(e) {
    e.preventDefault();
    uploadStatus.innerHTML = "";
    if (!queryTextarea.value.trim()) {
        queryTextarea.focus();
        return;
    }
    
    // Store the question before clearing the textarea
    const userQuestion = queryTextarea.value.trim();
    
    // Create new session if none exists
    if (!currentSessionId) {
        await createNewSession();
    }
    
    showSpinner();
    const formData = new FormData();
    formData.append('query', userQuestion);
    formData.append('session_id', currentSessionId);
    formData.append('private', document.getElementById('private').checked);
    
    const resp = await fetch('/query', {method: 'POST', body: formData});
    const result = await resp.json();
    hideSpinner();
    
    // Display both question and answer
    document.getElementById('chat-answer').innerHTML = `
        <div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
            <div class="mb-3">
                <span class="fw-bold text-primary">Q:</span> 
                <span class="text-dark">${userQuestion}</span>
            </div>
            <div>
                <span class="fw-bold text-success">A:</span> 
                <div class="card shadow-sm mt-2" style="background-color: #FFFFE4; border-radius: 8px;">
                    <div class="card-body" style="font-size: 0.95rem; line-height: 1.6; color: #333;">
                        ${formatAnswer(result.answer)}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    queryTextarea.value = '';
    
    // Refresh session list if name was updated
    if (result.session_name_updated) {
        await loadUserSessions();
    }
    
    // Load history after the query
    await loadCurrentSessionHistory();
};

// Handle file upload independently
uploadBtn.onclick = async function(e) {
    e.preventDefault();
    if (!fileInput.files.length) {
        uploadStatus.innerHTML = `<div class="alert alert-warning mb-0">Please select file(s) to upload.</div>`;
        return;
    }

    showSpinner(`Uploading and processing ${fileInput.files.length} file(s)...`);

    const formData = new FormData();
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('files', fileInput.files[i]);
    }
    formData.append('private', document.getElementById('private').checked);

    // FIX: Always send session_id with upload
    if (!currentSessionId) {
        await createNewSession();
    }
    formData.append('session_id', currentSessionId);

    try {
        const resp = await fetch('/upload', {method: 'POST', body: formData});
        const result = await resp.json();
        hideSpinner();

        let statusHtml = `<div class="alert alert-success mb-2">
            <strong>${result.message}</strong><br>
        `;

        if (result.processed_files && result.processed_files.length > 0) {
            statusHtml += `<small>Successfully processed: ${result.processed_files.join(', ')}</small><br>`;
        }

        if (result.errors && result.errors.length > 0) {
            statusHtml += `<small class="text-warning">Errors: ${result.errors.join('; ')}</small>`;
        }

        statusHtml += `</div>`;
        uploadStatus.innerHTML = statusHtml;

    } catch (error) {
        hideSpinner();
        uploadStatus.innerHTML = `<div class="alert alert-danger mb-2">Upload failed: ${error.message}</div>`;
    }
};

// Create new session
async function createNewSession() {
    const resp = await fetch('/new_session', {method: 'POST'});
    const result = await resp.json();
    currentSessionId = result.session_id;
    
    // Clear current chat
    document.getElementById('chat-answer').innerHTML = '';
    document.getElementById('chat-history').innerHTML = '<em>No chat history yet.</em>';
    
    // Refresh session list
    await loadUserSessions();
    return currentSessionId;
}

// Handle New Chat button
document.getElementById('new-chat-btn').onclick = async function() {
    await createNewSession();
    queryTextarea.value = '';
    queryTextarea.focus();
};

// Load user sessions
async function loadUserSessions() {
    try {
        const resp = await fetch('/user_sessions');
        const result = await resp.json();
        userSessions = result.sessions || [];
        
        console.log('Loaded sessions:', userSessions);
        
        // If no sessions exist, create one
        if (userSessions.length === 0) {
            console.log('No sessions found, creating new one');
            await createNewSession();
            // Reload sessions after creating the first one
            const resp2 = await fetch('/user_sessions');
            const result2 = await resp2.json();
            userSessions = result2.sessions || [];
        }
        
        // Set current session if not already set
        if (!currentSessionId && userSessions.length > 0) {
            currentSessionId = userSessions[0].session_id;
            console.log('Set current session to:', currentSessionId);
            await loadCurrentSessionHistory();
        }
        
        renderSessionList();
    } catch (error) {
        console.error('Error loading sessions:', error);
        await createNewSession();
    }
}

document.getElementById('sidebar-toggle').onclick = function() {
    const sidebarContainer = document.getElementById('sidebar-container');
    const mainContent = document.getElementById('main-content');
    
    if (sidebarContainer.classList.contains('collapsed')) {
        // Expand sidebar
        sidebarContainer.classList.remove('collapsed');
        sidebarContainer.style.width = '280px';
        mainContent.classList.remove('expanded');
        mainContent.style.marginLeft = '280px';
    } else {
        // Collapse sidebar
        sidebarContainer.classList.add('collapsed');
        sidebarContainer.style.width = '60px';
        mainContent.classList.add('expanded');
        mainContent.style.marginLeft = '60px';
    }
};

// Handle dropdown visibility
document.addEventListener('click', function(e) {
    // Close all dropdowns when clicking outside
    if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// Handle dropdown toggle
function toggleDropdown(event, sessionId) {
    event.stopPropagation();
    
    // Close all other dropdowns first
    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        menu.classList.remove('show');
    });
    
    // Get current dropdown and button position
    const button = event.target.closest('button');
    const dropdown = event.target.closest('.dropdown').querySelector('.dropdown-menu');
    const buttonRect = button.getBoundingClientRect();
    
    // Position dropdown relative to button
    dropdown.style.top = (buttonRect.bottom + 5) + 'px';
    dropdown.style.right = '15px';
    
    // Toggle current dropdown
    dropdown.classList.toggle('show');
}

// Render session list
function renderSessionList() {
    const sessionList = document.getElementById('session-list');
    if (userSessions.length === 0) {
        sessionList.innerHTML = '<em class="text-muted small px-3 sidebar-text">No sessions yet</em>';
        return;
    }
    
    sessionList.innerHTML = userSessions.map(session => `
    <div class="position-relative session-item d-flex align-items-center" style="border-radius: 8px; transition: all 0.2s ease; margin-bottom: 4px;">
        <!-- Three dots button on the left -->
        <div class="dropdown me-2 sidebar-text position-static">
    <button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport"
            style="border: none; background: none; opacity: 0.7; padding: 4px 6px; margin-left: 8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
        </svg>
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow">
        <li><a class="dropdown-item rename-session d-flex align-items-center" href="#" data-session-id="${session.session_id}">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pencil me-2" viewBox="0 0 16 16">
                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L10.5 8.207l-3-3L12.146.146zM11.207 9.207l-3-3L2.5 12.914a.5.5 0 0 0-.146.353V14.5a.5.5 0 0 0 .5.5h1.233a.5.5 0 0 0 .353-.146l5.707-5.707z"/>
            </svg>
            Rename
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item delete-session text-danger d-flex align-items-center" href="#" data-session-id="${session.session_id}">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash me-2" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
            Delete
        </a></li>
    </ul>
</div>
        
        <!-- Chat button taking remaining space -->
        <button class="btn btn-light border-0 text-start d-flex align-items-center py-2 px-3 flex-grow-1 session-btn-custom ${session.session_id === currentSessionId ? 'active' : ''}" 
                data-session-id="${session.session_id}" 
                style="background-color: #f8f9fa; border-radius: 8px; font-size: 0.9em; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chat-left me-2 flex-shrink-0" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
            </svg>
            <span class="flex-grow-1 sidebar-text" style="overflow: hidden; text-overflow: ellipsis; max-width: 150px;">${session.session_name || 'Untitled Chat'}</span>
        </button>
    </div>
`).join('');
    
    // Re-attach event listeners for chat buttons
    document.querySelectorAll('.session-btn-custom').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const sessionId = parseInt(this.dataset.sessionId);
            console.log('Switching to session:', sessionId);
            switchToSession(sessionId);
        });
    });
    
    // Update rename and delete event listeners
    document.querySelectorAll('.rename-session').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const sessionId = parseInt(this.dataset.sessionId);
            const session = userSessions.find(s => s.session_id === sessionId);
            document.getElementById('newSessionName').value = session.session_name || '';
            document.getElementById('sessionToRename').value = sessionId;
            
            // Close dropdown
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            new bootstrap.Modal(document.getElementById('renameSessionModal')).show();
        };
    });

    document.querySelectorAll('.delete-session').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const sessionId = parseInt(this.dataset.sessionId);
            
            // Close dropdown
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            deleteSession(sessionId);
        };
    });
}

// Handle dropdown positioning and z-index
document.addEventListener('show.bs.dropdown', function (event) {
    const dropdownMenu = event.target.nextElementSibling;
    if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
        // Move dropdown to body to escape z-index constraints
        document.body.appendChild(dropdownMenu);
        
        // Position it correctly
        const button = event.target;
        const rect = button.getBoundingClientRect();
        dropdownMenu.style.position = 'fixed';
        dropdownMenu.style.top = (rect.bottom + 5) + 'px';
        dropdownMenu.style.left = (rect.left + rect.width + 5) + 'px';
        dropdownMenu.style.zIndex = '9999';
    }
});

document.addEventListener('hide.bs.dropdown', function (event) {
    const dropdownMenu = event.target.nextElementSibling;
    if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu') && dropdownMenu.parentElement === document.body) {
        // Move it back to original parent
        event.target.parentElement.appendChild(dropdownMenu);
        dropdownMenu.style.position = '';
        dropdownMenu.style.top = '';
        dropdownMenu.style.left = '';
        dropdownMenu.style.zIndex = '';
    }
});

// Switch to a different session
async function switchToSession(sessionId) {
    currentSessionId = sessionId;
    
    // Clear current answer area first
    document.getElementById('chat-answer').innerHTML = '';
    
    // Load session history
    await loadCurrentSessionHistory();
    
    // Update active session in UI
    document.querySelectorAll('.session-btn-custom').forEach(btn => {
        btn.classList.remove('active');
        btn.style.backgroundColor = '#f8f9fa';
        if (parseInt(btn.dataset.sessionId) === sessionId) {
            btn.classList.add('active');
            btn.style.backgroundColor = '#e3f2fd';
        }
    });
}

// Rename session
document.getElementById('confirmRename').onclick = async function() {
    const sessionId = parseInt(document.getElementById('sessionToRename').value);
    const newName = document.getElementById('newSessionName').value.trim();
    
    if (!newName) {
        alert('Please enter a session name');
        return;
    }
    
    const formData = new FormData();
    formData.append('session_id', sessionId);
    formData.append('new_name', newName);
    
    const resp = await fetch('/rename_session', {method: 'POST', body: formData});
    if (resp.ok) {
        bootstrap.Modal.getInstance(document.getElementById('renameSessionModal')).hide();
        await loadUserSessions();
    }
};

// Delete session
async function deleteSession(sessionId) {
    const formData = new FormData();
    formData.append('session_id', sessionId);
    
    const resp = await fetch('/delete_session', {method: 'POST', body: formData});
    if (resp.ok) {
        if (currentSessionId === sessionId) {
            currentSessionId = null;
            document.getElementById('chat-answer').innerHTML = '';
            document.getElementById('chat-history').innerHTML = '<em>No chat history yet.</em>';
        }
        await loadUserSessions();
    }
}

// Load current session history
async function loadCurrentSessionHistory() {
    console.log('Loading history for session:', currentSessionId);
    
    if (!currentSessionId) {
        document.getElementById('chat-history').innerHTML = '<em class="text-muted">No chat history yet.</em>';
        return;
    }
    
    try {
        const resp = await fetch(`/history?session_id=${currentSessionId}`);
        if (!resp.ok) {
            console.error('History fetch failed:', resp.status, resp.statusText);
            throw new Error(`Failed to load history: ${resp.status}`);
        }
        
        const result = await resp.json();
        console.log('History result:', result);
        
        const historyDiv = document.getElementById('chat-history');
        
        if (result.history && result.history.length > 0) {
            const currentDate = new Date();
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = date.toLocaleString('en-US', { month: 'short' });
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            };
            
            historyDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 text-dark">Chat History</h4>
                    <span class="text-muted small">${formatDate(currentDate)}</span>
                </div>
                <div class="chat-history-content">
                    ${result.history.map(
                        qa => `<div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                            <div class="mb-2"><span class="fw-bold text-primary">Q:</span> <span class="text-dark">${qa.question}</span></div>
                            <div><span class="fw-bold text-success">A:</span> <div class="mt-1">${formatAnswer(qa.answer)}</div></div>
                        </div>`
                    ).join('')}
                </div>
            `;
            console.log(`Loaded ${result.history.length} history items`);
        } else {
            const currentDate = new Date();
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = date.toLocaleString('en-US', { month: 'short' });
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            };
            
            historyDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 text-dark">Chat History</h4>
                    <span class="text-muted small">${formatDate(currentDate)}</span>
                </div>
                <em class="text-muted">No chat history yet. Start a conversation!</em>
            `;
            console.log('No history found for session');
        }
    } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('chat-history').innerHTML = '<div class="alert alert-warning">Failed to load chat history. Please try refreshing the page.</div>';
    }
}

function formatAnswer(answer) {
    // Clean up the answer for better formatting
    
    // If the answer already contains HTML tables, just clean up spacing around them
    if (answer.includes('<table>')) {
        // Remove excessive line breaks before and after tables
        answer = answer.replace(/\s*<table>/g, '<table>');
        answer = answer.replace(/<\/table>\s*/g, '</table>');
        
        // Clean up any text before tables - remove extra line breaks
        answer = answer.replace(/(.+?)\s*\n\s*<table>/g, '$1<table>');
        
        // Style existing HTML tables with Bootstrap classes
        answer = answer.replace(/<table>/g, '<table class="table table-striped table-bordered table-hover mt-2 mb-3" style="width: auto; max-width: 600px;">');
        answer = answer.replace(/<th>/g, '<th class="bg-light text-dark fw-bold px-3 py-2" style="font-size: 0.9rem;">');
        answer = answer.replace(/<td>/g, '<td class="px-3 py-2" style="font-size: 0.9rem;">');
        
        // Clean up any remaining line breaks and extra spaces
        answer = answer.replace(/\n{2,}/g, ' ');
        answer = answer.replace(/\s{2,}/g, ' ');
        
        return answer.trim();
    }
    
    // Handle non-table content
    
    // Remove lines that are just asterisks
    answer = answer.replace(/^\s*\*+\s*$/gm, '');
    answer = answer.replace(/^\*+\s*/gm, '');
    answer = answer.replace(/\s*\*+$/gm, '');
    
    // Format Markdown tables to Bootstrap tables (if any exist)
    answer = answer.replace(
        /((?:\|[^\n]+\|\n?)+)/g,
        function(tableBlock) {
            const rows = tableBlock.trim().split('\n');
            let html = '<table class="table table-striped table-bordered table-hover mt-2 mb-3" style="width: auto; max-width: 600px;">';
            rows.forEach((row, idx) => {
                const cells = row.split('|').filter(cell => cell.trim().length > 0);
                if (cells.length && !cells.every(cell => cell.trim() === '-' || cell.trim() === '')) {
                    html += '<tr>';
                    cells.forEach(cell => {
                        if (idx === 0) {
                            html += `<th class="bg-light text-dark fw-bold px-3 py-2" style="font-size: 0.9rem;">${cell.trim()}</th>`;
                        } else {
                            html += `<td class="px-3 py-2" style="font-size: 0.9rem;">${cell.trim()}</td>`;
                        }
                    });
                    html += '</tr>';
                }
            });
            html += '</table>';
            return html;
        }
    );
    
    // Format headers and bold text
    answer = answer.replace(/\*\*([^*]+)\*\*/g, '<strong class="text-dark">$1</strong>');
    answer = answer.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Convert line breaks to HTML breaks, but be conservative
    answer = answer.replace(/\n{3,}/g, '\n\n');
    answer = answer.replace(/\n/g, '<br>');
    
    // Clean up excessive breaks
    answer = answer.replace(/^(<br>)+/, '');
    answer = answer.replace(/(<br>)+$/, '');
    answer = answer.replace(/(<br>){3,}/g, '<br><br>');
    
    // Remove extra spaces
    answer = answer.replace(/\s{2,}/g, ' ');
    
    return answer.trim();
}

// Initialize on page load
window.onload = function() {
    loadUserSessions();
};
</script>
{% endblock %}